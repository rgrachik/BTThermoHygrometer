#include <Wire.h>
#include <Adafruit_Sensor.h>
#include <Adafruit_BME280.h>
#include <SoftwareSerial.h>
#include <ArduinoJson.h>
#include <GyverOLED.h>

#define SEALEVELPRESSURE_HPA (1015.4)
SoftwareSerial bluetooth(8,9);
Adafruit_BME280 bme;
GyverOLED<SSD1306_128x64, OLED_NO_BUFFER> oled;
const uint8_t duino[] PROGMEM={ //-- width: 128, height: 64
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xe0,
0xf0,0x38,0x18,0x18,0x38,0xf0,0xe0,0x0,0x0,0xc0,0xc0,0xc0,0xc0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x80,0xc0,0xc0,0xe0,0x70,0x30,0x38,0x38,0x18,0x18,0x18,0x18,0x18,0x38,
0x38,0x30,0x70,0x60,0xe0,0xc0,0x80,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x80,0x80,0x80,0xc0,0xc0,0xc0,0xc0,
0x80,0x80,0x80,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xff,
0xff,0x0,0xc0,0xc0,0x0,0xff,0xff,0x0,0x0,0x4c,0xcc,0xcc,0xcc,0x44,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xe0,
0xfc,0x7e,0xf,0x3,0x1,0x30,0x30,0x4,0xe,0x6,0x0,0x3,0xe3,0xc3,0x0,0x6,
0xe,0x6,0x30,0x30,0x30,0x1,0x7,0x1f,0xfe,0xf8,0x80,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xc,0x1c,0x18,0x38,0x38,0x38,
0x38,0x38,0x18,0x1c,0xc,0xe,0x6,0x7,0x83,0x83,0xc1,0xc1,0xc1,0x1,0x1,0xc1,
0xe1,0xe3,0xc3,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x80,0xe0,0xf0,0x3f,
0x1f,0x80,0xff,0xff,0x80,0x1f,0x3f,0xf0,0xe0,0x84,0x6,0x6,0x6,0x4,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x1f,
0x7f,0xfc,0xc0,0x80,0x0,0x0,0x0,0x0,0x0,0x0,0x40,0xe0,0xff,0xff,0xe0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0xc0,0xf0,0xff,0x3f,0x3,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xe,0xc,0x1c,0x1c,0x18,0x18,
0x18,0x1c,0xc,0xc,0xe,0x6,0x87,0x83,0xc3,0x41,0x1,0xc0,0xf0,0x3c,0xf,0x3,
0x0,0x0,0x3,0xf,0x3c,0xf0,0xc0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x1f,0x3f,0x70,0xe0,
0xcf,0xdf,0x9f,0x9f,0x9f,0xcf,0xe0,0x70,0x3f,0x1f,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x1,0x3,0x7,0xf,0xe,0x1c,0x18,0x38,0x38,0x30,0x30,0x31,0x31,0x30,0x30,
0x38,0x38,0x1c,0x1c,0xe,0x7,0x3,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x6,0x6,0xe,0xc,0xc,0xc,
0xc,0xc,0xe,0x6,0x7,0x3,0x3,0x1,0x1,0x0,0x0,0x7,0xf,0x1c,0x38,0x30,
0x30,0x30,0x30,0x18,0x1c,0xf,0x3,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x1,0x1,0x1,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,
0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0
};

void setup() 
{
  //pinMode(13, OUTPUT);
  //digitalWrite(13, LOW);

  Serial.begin(9600);

  bluetooth.begin(9600);

  if (!bme.begin(0x76)) 
  {
    Serial.println("Could not find a valid BME280 sensor, check wiring!");
    while (1);
  }
  

  oled.init();  // инициализация

  oled.clear();   // очистить дисплей (или буфер)
  oled.update();  // обновить. Только для режима с буфером! OLED_BUFFER

  oled.home();            // курсор в 0,0
  oled.drawBitmap(0, 0, duino, 128, 64);   // печатай что угодно: числа, строки, float, как Serial!
  oled.update();
  delay(2000);
  oled.clear(); 

}

void loop() 
{
  
  // Создание объекта JSON
  StaticJsonDocument<200> jsonDoc;

  // Добавление данных в объект JSON
  jsonDoc["temperature"] = bme.readTemperature();
  jsonDoc["pressure"] = bme.readPressure() / 133.3;
  jsonDoc["humidity"] = bme.readHumidity();
  jsonDoc["altitude"] = bme.readAltitude(SEALEVELPRESSURE_HPA);

  // Сериализация объекта JSON в строку
  String jsonString;
  serializeJson(jsonDoc, jsonString);

  // Отправка строки через Bluetooth
  bluetooth.println(jsonString);

  // Вывод строки в монитор порта для отладки
  Serial.println(jsonString);

  oled.setCursor(0, 2);           // курсор в 0,0
  oled.setScale(1);
  oled.print("Температура "); 
  oled.print(bme.readTemperature());  // печатай что угодно: числа, строки, float, как Serial!
  oled.print(" *C");

  oled.setCursor(0, 4);
  oled.print("Давление "); 
  oled.print(bme.readPressure() / 133.3);  // печатай что угодно: числа, строки, float, как Serial!
  oled.print(" mmHg");

  oled.setCursor(0, 6);
  oled.print("Влажность "); 
  oled.print(bme.readHumidity());  // печатай что угодно: числа, строки, float, как Serial!
  oled.print(" %");

  delay(2000);

}


